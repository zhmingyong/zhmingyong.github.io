---
layout:     post
title:      Docker支持多平台镜像构建
subtitle:   buildx
date:       2024-8-6
author:     zhmingyong
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - Docker
    - buildx
---


## Docker安装
Centos7.9为例

### yum源更新
- 更新为华为云yum源
```shell
wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo
```

- 清理并重建缓存
```shell
yum clean all
yum makecache
```

- 配置docker-ce源为阿里云
```shell
yum install -y yum-utils
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

- 安装docker-ce及其依赖
```shell

```

## buildx driver配置
buildx配置文件`buildkitd.toml`，支持私服http连接
```shell
debug = true
# insecure-entitlements allows insecure entitlements, disabled by default.
insecure-entitlements = [ "network.host", "security.insecure" ]

# optionally mirror configuration can be done by defining it as a registry.
[registry."registryUrl"]
  http = true
  insecure = true
```

执行配置
```shell
docker buildx create --use --driver-opt image=registry/buildkit:buildx-stable-1 --config /buildkitd.toml
```

## 多平台镜像构建

构建命令
```shell
docker buildx build -t registryUrl/xxx:v1 --platform=linux/arm64,linux/amd64 -o type=image,push=true ./
```